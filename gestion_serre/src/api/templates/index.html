<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serre Connectée - Tableau de Bord</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .status-grid, .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-item, .control-card {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            border-left: 5px solid #3498db;
        }
        .control-card {
            border-left-color: #2ecc71;
        }
        .status-item p, .control-card p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .status-item strong, .control-card strong {
            color: #2980b9;
        }
        .control-card strong {
            color: #27ae60;
        }
        .status-value {
            font-weight: bold;
            color: #333;
        }
        .on { color: #27ae60; font-weight: bold; }
        .off { color: #c0392b; font-weight: bold; }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            margin: 5px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        .button-group {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        /* L'élément #loading-status n'est plus utilisé pour afficher/masquer, 
           mais on pourrait le styler différemment si on voulait un message permanent.
           Pour l'instant, on le commente ou on le supprime du HTML si non désiré.
        #loading-status {
            text-align: center;
            padding: 10px;
            color: #7f8c8d;
            font-style: italic;
        }
        */
        .timestamp {
            text-align: center;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 20px;
            min-height: 1.2em; /* Pour éviter un léger saut si le texte change de longueur */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tableau de Bord de la Serre Connectée</h1>
        <p class="timestamp">Dernière mise à jour: <span id="timestamp-value">Chargement initial...</span></p>
        <h2>État Actuel des Capteurs</h2>
        <div class="status-grid">
            <div class="status-item">
                <p><strong>Température:</strong> <span id="temperature" class="status-value">N/A</span> °C</p>
            </div>
            <div class="status-item">
                <p><strong>Humidité:</strong> <span id="humidite" class="status-value">N/A</span> %</p>
            </div>
            <div class="status-item">
                <p><strong>CO₂:</strong> <span id="co2" class="status-value">N/A</span> ppm</p>
            </div>
            <div class="status-item">
                <p><strong>Lecture Capteurs:</strong> <span id="sensor_read_ok" class="status-value">N/A</span></p>
            </div>
        </div>

        <h2>État et Contrôle des Actionneurs</h2>
        <div class="controls-grid">
            <div class="control-card" id="leds-card">
                <p><strong>Lumières (LEDs):</strong> <span id="leds_is_active" class="status-value off">N/A</span></p>
                <p>Mode: <span id="leds_manual_mode">N/A</span></p>
                <p>Allumées depuis: <span id="leds_on_duration">N/A</span> s</p>
                <p>Éteintes depuis: <span id="leds_off_duration">N/A</span> s</p>
                <div class="button-group">
                    <button onclick="controlDevice('leds', 'on')">Allumer</button>
                    <button onclick="controlDevice('leds', 'off')">Éteindre</button>
                </div>
            </div>

            <div class="control-card" id="humidifier-card">
                <p><strong>Humidificateur:</strong> <span id="humidifier_is_active" class="status-value off">N/A</span></p>
                <p>Mode: <span id="humidifier_manual_mode">N/A</span></p>
                <p>Actif depuis: <span id="humidifier_on_duration">N/A</span> s</p>
                <p>Inactif depuis: <span id="humidifier_off_duration">N/A</span> s</p>
                <div class="button-group">
                    <button onclick="controlDevice('humidifier', 'on')">Activer</button>
                    <button onclick="controlDevice('humidifier', 'off')">Désactiver</button>
                </div>
            </div>

            <div class="control-card" id="ventilation-card">
                <p><strong>Ventilation:</strong> <span id="ventilation_is_active" class="status-value off">N/A</span></p>
                <p>Mode: <span id="ventilation_manual_mode">N/A</span></p>
                <p>Active depuis: <span id="ventilation_on_duration">N/A</span> s</p>
                <p>Inactive depuis: <span id="ventilation_off_duration">N/A</span> s</p>
                <div class="button-group">
                    <button onclick="controlDevice('ventilation', 'on')">Activer</button>
                    <button onclick="controlDevice('ventilation', 'off')">Désactiver</button>
                </div>
            </div>
        </div>
        
        <h2>Commandes Globales</h2>
        <div class="button-group" style="flex-direction: column; align-items: center;">
            <button class="secondary" onclick="setGlobalAutoMode()">Passer tout en Mode Automatique</button>
            <button class="danger" onclick="emergencyStop()">Arrêt d'Urgence Global</button>
        </div>

    </div>

    <script>
        // Fonction pour mettre à jour l'état d'un appareil (LEDs, Humidificateur, Ventilation)
        function updateDeviceStatus(deviceData, deviceName) {
            const isActiveElement = $(`#${deviceName}_is_active`);
            const newStatusText = deviceData.is_active ? 'ACTIF' : 'INACTIF';
            if (isActiveElement.text() !== newStatusText) { // Mettre à jour seulement si le texte change
                isActiveElement.text(newStatusText);
                isActiveElement.removeClass('on off').addClass(deviceData.is_active ? 'on' : 'off');
            }
            
            $(`#${deviceName}_manual_mode`).text(deviceData.manual_mode ? 'Manuel' : 'Automatique');
            $(`#${deviceName}_on_duration`).text(deviceData.on_duration_seconds.toFixed(1));
            $(`#${deviceName}_off_duration`).text(deviceData.off_duration_seconds.toFixed(1));
        }

        // Fonction pour mettre à jour l'affichage du statut global
        function updateStatusDisplay() {
            const timestampValueElement = $('#timestamp-value');
            const originalTimestampText = timestampValueElement.text(); // Sauvegarder le texte actuel du timestamp
            timestampValueElement.text('Mise à jour...'); // Indiquer le chargement

            $.getJSON('/status', function(data) {
                timestampValueElement.text(data.timestamp || 'N/A'); // Restaurer avec la nouvelle valeur
                
                $('#temperature').text(data.temperature !== "N/A" ? parseFloat(data.temperature).toFixed(1) : 'N/A');
                $('#humidite').text(data.humidite !== "N/A" ? parseFloat(data.humidite).toFixed(1) : 'N/A');
                $('#co2').text(data.co2 !== "N/A" ? parseFloat(data.co2).toFixed(0) : 'N/A');
                
                const sensorOkElement = $('#sensor_read_ok');
                const newSensorStatusText = data.sensor_read_ok ? 'OK' : 'Erreur';
                if (sensorOkElement.text() !== newSensorStatusText) {
                    sensorOkElement.text(newSensorStatusText);
                    sensorOkElement.removeClass('on off').addClass(data.sensor_read_ok ? 'on' : 'off');
                }


                if (data.leds) {
                    updateDeviceStatus(data.leds, 'leds');
                }
                if (data.humidifier) {
                    updateDeviceStatus(data.humidifier, 'humidifier');
                }
                if (data.ventilation) {
                    updateDeviceStatus(data.ventilation, 'ventilation');
                }
                
            }).fail(function(jqXHR, textStatus, errorThrown) {
                timestampValueElement.text(originalTimestampText); // Restaurer l'ancien timestamp en cas d'erreur
                // Optionnel: afficher un message d'erreur plus persistant ailleurs
                console.error("Erreur AJAX pour /status:", textStatus, errorThrown);
                // Vous pourriez ajouter un petit message d'erreur discret à côté du timestamp
                // $('#timestamp-error').text('Erreur de chargement.').show().delay(3000).fadeOut();
            });
        }

        // Fonction générique pour contrôler un appareil
        function controlDevice(deviceName, action) {
            const timestampValueElement = $('#timestamp-value');
            timestampValueElement.text(`Contrôle de ${deviceName}...`);

            $.post(`/control/${deviceName}`, { action: action }, function(response) {
                if (response.success) {
                    updateStatusDisplay(); 
                } else {
                    alert(`Erreur lors du contrôle de ${deviceName}: ${response.message}`);
                    updateStatusDisplay(); // Mettre à jour même en cas d'erreur pour refléter l'état actuel
                }
            }).fail(function() {
                alert(`Erreur de communication serveur pour contrôler ${deviceName}.`);
                updateStatusDisplay(); // Mettre à jour pour refléter l'état actuel
            });
        }

        // Fonction pour passer tous les appareils en mode automatique
        function setGlobalAutoMode() {
            const timestampValueElement = $('#timestamp-value');
            timestampValueElement.text('Passage en mode automatique...');
            $.post('/control/auto_mode', function(response) {
                if (response.success) {
                    updateStatusDisplay();
                } else {
                    alert(`Erreur lors du passage en mode auto: ${response.message}`);
                    updateStatusDisplay();
                }
            }).fail(function() {
                alert('Erreur de communication serveur pour le mode automatique.');
                updateStatusDisplay();
            });
        }

        // Fonction pour l'arrêt d'urgence
        function emergencyStop() {
            if (!confirm("Êtes-vous sûr de vouloir effectuer un arrêt d'urgence ? Tous les appareils seront désactivés.")) {
                return;
            }
            const timestampValueElement = $('#timestamp-value');
            timestampValueElement.text("Arrêt d'urgence en cours...");
            $.post('/control/emergency_stop', function(response) {
                if (response.success) {
                    updateStatusDisplay();
                } else {
                    alert(`Erreur lors de l'arrêt d'urgence: ${response.message}`);
                    updateStatusDisplay();
                }
            }).fail(function() {
                alert("Erreur de communication serveur pour l'arrêt d'urgence.");
                updateStatusDisplay();
            });
        }

        const refreshIntervalSeconds = 15; 
        setInterval(updateStatusDisplay, refreshIntervalSeconds * 1000);

        $(document).ready(function() {
            updateStatusDisplay();
        });
    </script>
</body>
</html>



